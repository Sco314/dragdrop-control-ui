<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Process Control System – Drag & Click</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --side-w: 300px; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; height: 100vh; display: flex; }

    /* Sidebar */
    #sidebar { width: var(--side-w); background:#f7f7f7; border-right:1px solid #ddd; padding:12px; display:flex; flex-direction:column; gap:10px; }
    #toolbar button { width:100%; padding:8px 10px; margin:4px 0; cursor:pointer; }
    #loginArea { border:1px solid #ddd; background:#fff; padding:8px; }
    #word-bank { background:#fff; border:1px solid #ccc; padding:8px; min-height:120px; overflow:auto; }
    .label { display:block; padding:6px 10px; margin:6px 0; border:2px solid #000; background:#fff; cursor:pointer; user-select:none; }
    .label.used { opacity:.6; cursor:default; }
    #score { font-weight:600; }
    #attemptHistory { font-size:13px; border-top:1px solid #ddd; padding-top:8px; max-height:25vh; overflow:auto; }
    .hint { font-size:12px; color:#666; }
    .row { display:flex; gap:8px; }
    input[type=email] { width:100%; padding:8px; border:1px solid #bbb; border-radius:4px; }

    /* Stage */
    #stage { position:relative; flex:1; overflow:auto; background:#fff; display:flex; align-items:center; justify-content:center; }
    #imgWrap { position:relative; max-width:100%; max-height:100%; }
    #bgImg { display:block; max-width:100%; height:auto; }

    /* Hotspots */
    .dropzone {
      position:absolute;
      border:2px solid #000;
      border-radius:50%;
      width:100px; height:100px;
      transform:translate(-50%, -50%);
      display:flex; align-items:center; justify-content:center;
      background:transparent;
      user-select:none;
    }
    /* centered label text (teacher places text center on hotspot center) */
    .dropzone .label-text{
      position:absolute; left:50%; top:50%;
      transform:translate(-50%, -50%);
      font-weight:700;
      white-space:nowrap; /* don’t split words; text may extend outside the circle */
      line-height:1.1;
      pointer-events:none; /* clicks go to the hotspot, not the text */
    }

    /* teacher-only control bubble */
    .controls { display:none; position:absolute; bottom:110%; left:50%; transform:translateX(-50%); background:#fff; border:1px solid #ccc; border-radius:4px; padding:4px; gap:4px; z-index:3; }
    .dropzone.teacher .controls { display:flex; }

    /* student correctness */
    .dropzone.filled { border-color: transparent; }     /* hide circle after correct */
    .dropzone.flash  { border-color:#dc2626 !important; }/* wrong attempt flash red */

    /* drag cursor in teacher mode */
    .dropzone.teacher { cursor: move; }
    .dropzone.teacher.dragging { opacity:.7; }
  </style>
</head>
<body>
  <aside id="sidebar">
    <div id="loginArea">
      <div style="font-weight:700; margin-bottom:6px;">Student Login</div>
      <div class="row">
        <input id="emailInput" type="email" placeholder="name@school.org" />
      </div>
      <div class="row">
        <button id="loginBtn">Log in</button>
        <button id="logoutBtn" style="display:none;">Log out</button>
      </div>
      <div id="loggedAs" class="hint"></div>
    </div>

    <div id="toolbar">
      <button id="modeBtn">Enter Teacher Mode</button>
      <button id="clearHotspotsBtn" style="display:none;">Clear All Hotspots</button>
      <button id="clearAnswersBtn" style="display:inline-block;">Clear Answers</button>
    </div>

    <div id="word-bank"></div>
    <div id="score"></div>
    <div id="attemptHistory"></div>
  </aside>

  <main id="stage" aria-label="Activity stage">
    <div id="imgWrap">
      <img id="bgImg" alt="Activity diagram" src="Process_Control_System_label_valve_liquid_level_sensor_controller.png" />
    </div>
  </main>

  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = "https://boaanmcdttdbnkccfkhu.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvYWFubWNkdHRkYm5rY2Nma2h1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODA2MTcsImV4cCI6MjA3MDI1NjYxN30.KW6pAQcYRUZL2dT2n0Vh-5W5DKDO7TPnyzH_VY2NJ2E";
    const ACTIVITY_ID = "process-control-01";
    const TEACHER_PASSWORD = "teach123";

    // ====== DOM ======
    const imgWrap = document.getElementById("imgWrap");
    const bgImg   = document.getElementById("bgImg");
    const wordBank= document.getElementById("word-bank");
    const scoreDisplay = document.getElementById("score");
    const attemptHistory = document.getElementById("attemptHistory");
    const modeBtn = document.getElementById("modeBtn");
    const clearHotspotsBtn = document.getElementById("clearHotspotsBtn");
    const clearAnswersBtn  = document.getElementById("clearAnswersBtn");
    const emailInput = document.getElementById("emailInput");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const loggedAs = document.getElementById("loggedAs");

    // ====== STATE ======
    const labels = ["Valve", "Liquid Level Sensor", "Controller"];
    let selectedLabel = null;
    let isTeacher = false;                 // start in student mode
    let attempts = 0, placements = 0;

    // Require explicit login each load (don’t auto-login from localStorage)
    let studentEmail = "";
    const savedEmail = localStorage.getItem("studentEmail");
    if (savedEmail) {
      emailInput.placeholder = savedEmail; // convenience only
      emailInput.value = "";
    }

    let dzEls = [];                        // dropzone elements

    // ====== HELPERS ======
    function renderWordBank() {
      wordBank.innerHTML = "";
      const requireLogin = !isTeacher && (!studentEmail || !studentEmail.includes("@"));
      if (requireLogin) {
        const note = document.createElement("div");
        note.className = "hint";
        note.textContent = "Log in with your email to begin.";
        wordBank.appendChild(note);
        return;
      }
      labels.forEach(text => {
        const div = document.createElement("div");
        div.className = "label";
        div.textContent = text;
        div.addEventListener("click", () => {
          if (div.classList.contains("used")) return;
          selectedLabel = div;
          document.querySelectorAll(".label").forEach(l => l.style.border = "2px solid #000");
          div.style.border = "2px solid #2563eb";
        });
        wordBank.appendChild(div);
      });
    }

    function updateScore() {
      scoreDisplay.textContent = `${placements} placed / ${attempts} clicks`;
    }

    function imgDims() {
      const r = bgImg.getBoundingClientRect();
      return { left:r.left, top:r.top, w:r.width, h:r.height };
    }

    // ====== SUPABASE (REST) ======
    async function sbFetch(path, options = {}) {
      const url = `${SUPABASE_URL}${path}`;
      const headers = Object.assign({
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
      }, options.headers || {});
      const res = await fetch(url, { ...options, headers });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(`${res.status} ${res.statusText}: ${txt}`);
      }
      const ct = res.headers.get('content-type') || '';
      return ct.includes('application/json') ? res.json() : null;
    }

    async function loadHotspots() {
      const rows = await sbFetch(`/rest/v1/hotspots?activity_id=eq.${encodeURIComponent(ACTIVITY_ID)}&select=*`, { method:'GET' });
      rows.forEach(renderDropzoneFromRow);
      positionAllDropzones();
    }

    async function createHotspot(label, xPct, yPct, sizePct = 0.12) {
      const body = [{ activity_id: ACTIVITY_ID, label, x_pct: xPct, y_pct: yPct, size_pct: sizePct }];
      const row = await sbFetch('/rest/v1/hotspots', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Prefer':'return=representation' },
        body: JSON.stringify(body)
      });
      const dz = renderDropzoneFromRow(row[0]);
      positionDropzone(dz);
      if (isTeacher) dz.classList.add('teacher'); // show controls immediately
      return dz;
    }

    async function deleteHotspot(id, el) {
      await sbFetch(`/rest/v1/hotspots?id=eq.${id}`, { method:'DELETE' });
      el.remove();
      dzEls = dzEls.filter(x => x !== el);
    }

    async function updateHotspot(id, patch) {
      await sbFetch(`/rest/v1/hotspots?id=eq.${id}`, {
        method:'PATCH',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(patch)
      });
    }

    // ====== DROPZONES ======
    function renderDropzoneFromRow(row) {
      const dz = document.createElement('div');
      dz.className = 'dropzone';
      dz.dataset.id = row.id;
      dz.dataset.correct = row.label;
      dz.dataset.xPct = row.x_pct ?? 0.5;
      dz.dataset.yPct = row.y_pct ?? 0.5;
      dz.dataset.sizePct = row.size_pct ?? 0.12;
      dz.dataset.textScale = row.text_scale ?? 1; // not persisted yet

      // center-anchored label text
      const span = document.createElement('span');
      span.className = 'label-text';
      span.textContent = row.label;
      dz.appendChild(span);

      // teacher controls
      const controls = document.createElement('div');
      controls.className = 'controls';
      controls.innerHTML = `
        <button class="del">Delete</button>
        <button class="bigger">+</button>
        <button class="smaller">-</button>
        <span style="width:8px"></span>
        <button class="tBigger">Text +</button>
        <button class="tSmaller">Text -</button>
      `;
      dz.appendChild(controls);

      // student click = attempt
      dz.addEventListener('click', async (e) => {
        if (isTeacher) return;  // teacher uses controls/drag
        if (!selectedLabel) return;

        attempts++;
        if (selectedLabel.textContent === dz.dataset.correct) {
          placements++;
          dz.classList.add('filled'); // hide circle, keep text
          selectedLabel.remove();
          selectedLabel = null;
          if (placements === labels.length) {
            await recordAttempt();
            alert('Great job! Your score was saved.');
          }
        } else {
          dz.classList.add('flash');
          setTimeout(() => dz.classList.remove('flash'), 5000);
          selectedLabel.style.border = '2px solid #d4a017';
          setTimeout(() => { if (selectedLabel) selectedLabel.style.border = '2px solid #000'; }, 5000);
        }
        updateScore();
      });

      // teacher: delete
      controls.querySelector('.del').addEventListener('click', async (e) => {
        e.stopPropagation(); if (!isTeacher) return;
        await deleteHotspot(dz.dataset.id, dz);
      });

      // teacher: resize circle
      controls.querySelector('.bigger').addEventListener('click', async (e) => {
        e.stopPropagation(); if (!isTeacher) return;
        const newPct = Math.min(1, parseFloat(dz.dataset.sizePct) * 1.2);
        dz.dataset.sizePct = newPct; positionDropzone(dz);
        await updateHotspot(dz.dataset.id, { size_pct: newPct });
      });
      controls.querySelector('.smaller').addEventListener('click', async (e) => {
        e.stopPropagation(); if (!isTeacher) return;
        const newPct = Math.max(0.02, parseFloat(dz.dataset.sizePct) * 0.8);
        dz.dataset.sizePct = newPct; positionDropzone(dz);
        await updateHotspot(dz.dataset.id, { size_pct: newPct });
      });

      // teacher: resize text (local only for now)
      controls.querySelector('.tBigger').addEventListener('click', (e) => {
        e.stopPropagation(); if (!isTeacher) return;
        dz.dataset.textScale = (parseFloat(dz.dataset.textScale) || 1) * 1.2;
        positionDropzone(dz);
      });
      controls.querySelector('.tSmaller').addEventListener('click', (e) => {
        e.stopPropagation(); if (!isTeacher) return;
        dz.dataset.textScale = Math.max(0.4, (parseFloat(dz.dataset.textScale) || 1) * 0.8);
        positionDropzone(dz);
      });

      // teacher: drag hotspot
      let dragging = false;
      let onMove, onUp;
      dz.addEventListener('mousedown', (e) => {
        if (!isTeacher) return;
        if (e.target.closest('.controls')) return;
        dragging = true;
        dz.classList.add('dragging');

        onMove = (ev) => {
          if (!dragging) return;
          const rect = bgImg.getBoundingClientRect();
          const xPct = (ev.clientX - rect.left) / rect.width;
          const yPct = (ev.clientY - rect.top)  / rect.height;
          dz.dataset.xPct = Math.min(1, Math.max(0, xPct));
          dz.dataset.yPct = Math.min(1, Math.max(0, yPct));
          positionDropzone(dz);
        };
        onUp = async () => {
          if (!dragging) return;
          dragging = false;
          dz.classList.remove('dragging');
          window.removeEventListener('mousemove', onMove);
          window.removeEventListener('mouseup', onUp);
          await updateHotspot(dz.dataset.id, {
            x_pct: parseFloat(dz.dataset.xPct),
            y_pct: parseFloat(dz.dataset.yPct)
          });
        };
        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onUp);
      });

      imgWrap.appendChild(dz);
      dzEls.push(dz);
      positionDropzone(dz);
      return dz;
    }

    function positionDropzone(dz) {
      const { w, h } = imgDims();
      const x = parseFloat(dz.dataset.xPct) * w;
      const y = parseFloat(dz.dataset.yPct) * h;
      const sz = (parseFloat(dz.dataset.sizePct) || 0.12) * w;
      dz.style.left = `${x}px`;
      dz.style.top  = `${y}px`;
      dz.style.width  = `${sz}px`;
      dz.style.height = `${sz}px`;
      const scale = parseFloat(dz.dataset.textScale) || 1;
      const span = dz.querySelector('.label-text');
      if (span) span.style.fontSize = `${sz * 0.35 * scale}px`;
    }

    function positionAllDropzones() { dzEls.forEach(positionDropzone); }

    // ====== ATTEMPTS ======
    async function recordAttempt() {
      if (!studentEmail) return;
      const body = [{ activity_id: ACTIVITY_ID, student_email: studentEmail, placements, clicks: attempts, result: `${placements} placed / ${attempts} clicks` }];
      await sbFetch('/rest/v1/attempts', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Prefer':'return=representation' },
        body: JSON.stringify(body)
      });
      refreshAttemptHistory();
    }

    async function refreshAttemptHistory() {
      if (!studentEmail) { attemptHistory.innerHTML = ''; return; }
      const rows = await sbFetch(`/rest/v1/attempts?activity_id=eq.${encodeURIComponent(ACTIVITY_ID)}&student_email=eq.${encodeURIComponent(studentEmail)}&select=*&order=completed_at.desc&limit=4`, { method:'GET' });
      attemptHistory.innerHTML = rows.map((r, i) => {
        const n = rows.length - i;
        return `<div><strong>Attempt ${n}</strong><br>${r.result}</div>`;
      }).join('<hr style="border:none;border-top:1px solid #eee;">');
    }

    // ====== TEACHER CLICK TO CREATE HOTSPOT ======
    const DEFAULT_SIZE_PCT = 0.12;

    imgWrap.addEventListener('click', async (e) => {
      if (!isTeacher || !selectedLabel) return;
      if (e.target.closest('.dropzone')) return; // ignore clicks on existing
      const rect = bgImg.getBoundingClientRect();
      const xPct = (e.clientX - rect.left) / rect.width;
      const yPct = (e.clientY - rect.top)  / rect.height;
      try {
        const dz = await createHotspot(selectedLabel.textContent, xPct, yPct, DEFAULT_SIZE_PCT);
        dz.classList.add('teacher'); // show controls immediately
      } catch (err) {
        alert('Could not save hotspot (check Supabase policies / keys).');
      }
    });

    // ====== UI WIRES ======
    modeBtn.addEventListener('click', () => {
      if (!isTeacher) {
        const pw = prompt('Enter teacher password:');
        if (pw !== TEACHER_PASSWORD) { alert('Incorrect password.'); return; }
        isTeacher = true;
        modeBtn.textContent = 'Switch to Student Mode';
        clearHotspotsBtn.style.display = 'inline-block';
        clearAnswersBtn.style.display = 'none';
        document.querySelectorAll('.dropzone').forEach(dz => dz.classList.add('teacher'));
      } else {
        isTeacher = false;
        modeBtn.textContent = 'Enter Teacher Mode';
        clearHotspotsBtn.style.display = 'none';
        clearAnswersBtn.style.display = 'inline-block';
        document.querySelectorAll('.dropzone').forEach(dz => dz.classList.remove('teacher'));
        attempts = 0; placements = 0; updateScore();
        selectedLabel = null;
      }
      renderWordBank(); // teacher always sees labels
    });

    clearHotspotsBtn.addEventListener('click', async () => {
      if (!isTeacher) return;
      const zones = Array.from(document.querySelectorAll('.dropzone'));
      for (const dz of zones) { try { await deleteHotspot(dz.dataset.id, dz); } catch(e){ console.warn(e);} }
    });

    clearAnswersBtn.addEventListener('click', () => {
      attempts = 0; placements = 0; updateScore();
      document.querySelectorAll('.dropzone').forEach(dz => { dz.classList.remove('filled'); });
      renderWordBank();
    });

    // ====== LOGIN ======
    function reflectLoginUI() {
      if (studentEmail) {
        emailInput.style.display = 'none';
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        loggedAs.textContent = `Logged in as ${studentEmail}`;
      } else {
        emailInput.style.display = 'inline-block';
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        loggedAs.textContent = '';
      }
      renderWordBank();
      refreshAttemptHistory().catch(()=>{});
    }

    loginBtn.addEventListener('click', () => {
      const v = (emailInput.value || '').trim();
      if (!v || !v.includes('@')) { alert('Please enter a valid email.'); return; }
      studentEmail = v;
      localStorage.setItem('studentEmail', studentEmail);
      reflectLoginUI();
    });

    logoutBtn.addEventListener('click', () => {
      studentEmail = '';
      localStorage.removeItem('studentEmail');
      reflectLoginUI();
      clearAnswersBtn.click();
      attemptHistory.innerHTML = '';
    });

    // ====== INIT ======
    async function init() {
      reflectLoginUI();
      updateScore();
      const doLoad = async () => {
        try { await loadHotspots(); positionAllDropzones(); }
        catch (err) { console.error('Load failed', err); alert('Could not load hotspots.'); }
      };
      if (bgImg.complete) doLoad();
      else bgImg.addEventListener('load', doLoad, { once:true });
      window.addEventListener('resize', positionAllDropzones);
    }
    init();
  </script>
</body>
</html>
