<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Process Control System – Drag & Click</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --side-w: 320px; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; height: 100vh; display: flex; }

    /* Sidebar */
    #sidebar { width: var(--side-w); background:#f7f7f7; border-right:1px solid #ddd; padding:12px; display:flex; flex-direction:column; gap:12px; }
    #toolbar button, #labelsPanel button { width:100%; padding:8px 10px; margin:4px 0; cursor:pointer; }
    #loginArea, #labelsPanel, #imagePanel { border:1px solid #ddd; background:#fff; padding:10px; }
    #word-bank { background:#fff; border:1px solid #ccc; padding:8px; min-height:120px; overflow:auto; }
    .label { display:block; padding:6px 10px; margin:6px 0; border:2px solid #000; background:#fff; cursor:pointer; user-select:none; }
    .label.used { opacity:.6; cursor:default; }
    #score { font-weight:600; }
    #attemptHistory { font-size:13px; border-top:1px solid #ddd; padding-top:8px; max-height:25vh; overflow:auto; }
    .hint { font-size:12px; color:#666; }
    .row { display:flex; gap:8px; }
    input[type=email] { width:100%; padding:8px; border:1px solid #bbb; border-radius:4px; }

    /* Stage */
    #stage { position:relative; flex:1; overflow:auto; background:#fff; display:flex; align-items:center; justify-content:center; }
    #imgWrap { position:relative; max-width:100%; max-height:100%; }
    #bgImg { display:block; max-width:100%; height:auto; }

    /* Hotspots */
    .dropzone {
      position:absolute;
      border:2px solid #000; border-radius:50%;
      width:100px; height:100px;
      transform:translate(-50%, -50%);
      display:flex; align-items:center; justify-content:center;
      background:transparent; user-select:none;
    }
    /* centered label text, hidden by default (students) */
    .dropzone .label-text{
      position:absolute; left:50%; top:50%; transform:translate(-50%, -50%);
      font-weight:700; white-space:nowrap; line-height:1.1; pointer-events:none;
      display:none;
    }
    /* Show text in teacher mode and after student is correct */
    .dropzone.teacher .label-text { display:block; }
    .dropzone.filled .label-text { display:block; }
    /* Student correctness visuals */
    .dropzone.filled { border-color: transparent; }
    .dropzone.flash  { border-color:#dc2626 !important; }
    /* Drag affordance in teacher mode */
    .dropzone.teacher { cursor: move; }
    .dropzone.teacher.dragging { opacity:.7; }

   /* teacher-only control bubble (compact) */
.controls{
  display:none;
  position:absolute;
  bottom:110%;
  left:50%;
  transform:translateX(-50%);
  background:#fff;
  border:1px solid #ccc;
  border-radius:6px;
  padding:6px 8px;
  z-index:3;
  box-shadow:0 2px 8px rgba(0,0,0,.12);
}
.dropzone.teacher .controls{ display:flex; gap:10px; align-items:flex-start; }

.controls .ctrl-delete button{
  padding:4px 6px; font-size:12px; line-height:1; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer;
}
.controls .ctrl-group{
  display:flex; flex-direction:column; align-items:center; gap:4px; min-width:60px;
}
.controls .ctrl-title{
  font-size:11px; font-weight:600; color:#333;
}
.controls .ctrl-buttons{
  display:flex; gap:6px;
}
.controls .ctrl-buttons button{
  width:26px; height:24px; padding:0;
  border:1px solid #ddd; background:#fff; border-radius:4px; font-size:14px; line-height:1; cursor:pointer;
}
.controls .ctrl-buttons button:active{ transform:translateY(1px); }
    /* Labels management list */
    .lblItem { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:4px 0; border-bottom:1px dashed #eee; }
    .lblItem span { font-size:14px; }
    .lblItem button { width:auto; padding:4px 6px; }
    #labelList { max-height:160px; overflow:auto; border:1px solid #eee; padding:6px; background:#fafafa; }

    .small { font-size:12px; color:#666; }
  </style>
</head>
<body>
  <aside id="sidebar">
    <div id="loginArea">
      <div style="font-weight:700; margin-bottom:6px;">Student Login</div>
      <div class="row">
        <input id="emailInput" type="email" placeholder="name@school.org" />
      </div>
      <div class="row">
        <button id="loginBtn">Log in</button>
        <button id="logoutBtn" style="display:none;">Log out</button>
      </div>
      <div id="loggedAs" class="hint"></div>
    </div>

    <div id="toolbar">
      <button id="modeBtn">Enter Teacher Mode</button>
      <button id="clearHotspotsBtn" style="display:none;">Clear All Hotspots</button>
      <button id="clearAnswersBtn" style="display:inline-block;">Clear Answers</button>
    </div>

    <div id="imagePanel" style="display:none;">
      <div style="font-weight:700; margin-bottom:6px;">Activity Image</div>
      <button id="changeImgBtn">Change Image</button>
      <input id="imgFileInput" type="file" accept="image/*" style="display:none;" />
      <div class="small">Current activity: <span id="activityIdLabel"></span></div>
    </div>

    <div id="labelsPanel" style="display:none;">
      <div style="font-weight:700; margin-bottom:6px;">Manage Labels</div>
      <div id="labelList"></div>
      <textarea id="labelsInput" rows="4" placeholder="Add labels: one per line or comma‑separated"></textarea>
      <button id="addLabelsBtn">Add Labels</button>
      <button id="clearLabelsBtn" style="background:#fef2f2; border:1px solid #fecaca;">Remove All Labels</button>
      <div class="small">Labels are tied to this activity.</div>
    </div>

    <div id="word-bank"></div>
    <div id="score"></div>
    <div id="attemptHistory"></div>
  </aside>

  <main id="stage" aria-label="Activity stage">
    <div id="imgWrap">
      <img id="bgImg" alt="Activity diagram" />
    </div>
  </main>

  <script>
    // ====== CONFIG (EDIT THESE) ======
    const SUPABASE_URL = "https://boaanmcdttdbnkccfkhu.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvYWFubWNkdHRkYm5rY2Nma2h1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODA2MTcsImV4cCI6MjA3MDI1NjYxN30.KW6pAQcYRUZL2dT2n0Vh-5W5DKDO7TPnyzH_VY2NJ2E";
    const ACTIVITY_ID = "process-control-01";
    const TEACHER_PASSWORD = "teach123";
    const BUCKET = "activity-images";

    // ====== DOM ======
    const imgWrap = document.getElementById("imgWrap");
    const bgImg   = document.getElementById("bgImg");
    const wordBank= document.getElementById("word-bank");
    const scoreDisplay = document.getElementById("score");
    const attemptHistory = document.getElementById("attemptHistory");
    const modeBtn = document.getElementById("modeBtn");
    const clearHotspotsBtn = document.getElementById("clearHotspotsBtn");
    const clearAnswersBtn  = document.getElementById("clearAnswersBtn");
    const emailInput = document.getElementById("emailInput");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const loggedAs = document.getElementById("loggedAs");

    // Teacher panels
    const labelsPanel = document.getElementById("labelsPanel");
    const labelList = document.getElementById("labelList");
    const labelsInput = document.getElementById("labelsInput");
    const addLabelsBtn = document.getElementById("addLabelsBtn");
    const clearLabelsBtn = document.getElementById("clearLabelsBtn");

    const imagePanel = document.getElementById("imagePanel");
    const changeImgBtn = document.getElementById("changeImgBtn");
    const imgFileInput = document.getElementById("imgFileInput");
    const activityIdLabel = document.getElementById("activityIdLabel");

    // ====== STATE ======
    let labels = [];                 // from DB
    let selectedLabel = null;
    let isTeacher = false;           // starts in student mode
    let attempts = 0, placements = 0;
    let studentEmail = "";           // explicit login (no auto-login)
    const savedEmail = localStorage.getItem("studentEmail");
    if (savedEmail) emailInput.placeholder = savedEmail;

    let dzEls = [];                  // dropzones in DOM
    const DEFAULT_SIZE_PCT = 0.12;

    // ====== HELPERS ======
    function updateScore() {
      scoreDisplay.textContent = `${placements} placed / ${attempts} clicks`;
    }

    function imgDims() {
      const r = bgImg.getBoundingClientRect();
      return { left:r.left, top:r.top, w:r.width, h:r.height };
    }

    function renderWordBank() {
      wordBank.innerHTML = "";
      const requireLogin = !isTeacher && (!studentEmail || !studentEmail.includes("@"));
      if (requireLogin) {
        const note = document.createElement("div");
        note.className = "hint";
        note.textContent = "Log in with your email to begin.";
        wordBank.appendChild(note);
        return;
      }
      labels.forEach(text => {
        const div = document.createElement("div");
        div.className = "label";
        div.textContent = text;
        div.addEventListener("click", () => {
          if (div.classList.contains("used")) return;
          selectedLabel = div;
          document.querySelectorAll(".label").forEach(l => l.style.border = "2px solid #000");
          div.style.border = "2px solid #2563eb";
        });
        wordBank.appendChild(div);
      });
    }

    function renderLabelManager() {
      labelList.innerHTML = "";
      labels.forEach(text => {
        const row = document.createElement("div");
        row.className = "lblItem";
        const sp = document.createElement("span");
        sp.textContent = text;
        const del = document.createElement("button");
        del.textContent = "Delete";
        del.addEventListener("click", async () => {
          await sbFetch(`/rest/v1/labels?activity_id=eq.${encodeURIComponent(ACTIVITY_ID)}&text=eq.${encodeURIComponent(text)}`, { method:'DELETE' });
          await loadLabels();
        });
        row.appendChild(sp); row.appendChild(del);
        labelList.appendChild(row);
      });
    }

    // ====== SUPABASE (REST) ======
    async function sbFetch(path, options = {}) {
      const url = `${SUPABASE_URL}${path}`;
      const headers = Object.assign({
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
      }, options.headers || {});
      const res = await fetch(url, { ...options, headers });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(`${res.status} ${res.statusText}: ${txt}`);
      }
      const ct = res.headers.get('content-type') || '';
      return ct.includes('application/json') ? res.json() : null;
    }

    async function ensureActivityRow() {
      // upsert the activity if it doesn't exist
      await sbFetch('/rest/v1/activities', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Prefer':'resolution=merge-duplicates' },
        body: JSON.stringify([{ id: ACTIVITY_ID, title: ACTIVITY_ID }])
      });
    }

    async function loadActivityImage() {
      const rows = await sbFetch(`/rest/v1/activities?id=eq.${encodeURIComponent(ACTIVITY_ID)}&select=image_url`, { method:'GET' });
      const url = rows && rows[0] && rows[0].image_url;
      if (url) {
        bgImg.src = url;
      } else {
        // fallback to a local file name if you keep one in repo (optional)
        bgImg.src = "Process_Control_System_label_valve_liquid_level_sensor_controller.png";
      }
    }

    async function loadLabels() {
      const rows = await sbFetch(`/rest/v1/labels?activity_id=eq.${encodeURIComponent(ACTIVITY_ID)}&select=text,ord&order=ord.asc`, { method:'GET' });
      labels = rows.map(r => r.text);
      renderWordBank();
      if (isTeacher) renderLabelManager();
    }

    async function addLabelsBulk(raw) {
      // split by newlines or commas
      const items = raw.split(/[\n,]/).map(s => s.trim()).filter(Boolean);
      if (!items.length) return;
      // compute next ord
      const current = await sbFetch(`/rest/v1/labels?activity_id=eq.${encodeURIComponent(ACTIVITY_ID)}&select=ord&order=ord.desc&limit=1`, { method:'GET' });
      let startOrd = (current[0]?.ord ?? 0) + 1;
      const body = items.map((t, i) => ({ activity_id: ACTIVITY_ID, text: t, ord: startOrd + i }));
      await sbFetch('/rest/v1/labels', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
      await loadLabels();
    }

    async function clearLabels() {
      await sbFetch(`/rest/v1/labels?activity_id=eq.${encodeURIComponent(ACTIVITY_ID)}`, { method:'DELETE' });
      await loadLabels();
    }

    // Hotspots
    async function loadHotspots() {
      const rows = await sbFetch(`/rest/v1/hotspots?activity_id=eq.${encodeURIComponent(ACTIVITY_ID)}&select=*`, { method:'GET' });
      rows.forEach(renderDropzoneFromRow);
      positionAllDropzones();
    }

    async function createHotspot(label, xPct, yPct, sizePct = DEFAULT_SIZE_PCT) {
      const body = [{ activity_id: ACTIVITY_ID, label, x_pct:xPct, y_pct:yPct, size_pct:sizePct }];
      const row = await sbFetch('/rest/v1/hotspots', {
        method:'POST', headers:{ 'Content-Type':'application/json', 'Prefer':'return=representation' }, body: JSON.stringify(body)
      });
      const dz = renderDropzoneFromRow(row[0]); positionDropzone(dz);
      if (isTeacher) dz.classList.add('teacher');
      return dz;
    }

    async function updateHotspot(id, patch) {
      await sbFetch(`/rest/v1/hotspots?id=eq.${id}`, {
        method:'PATCH', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(patch)
      });
    }

    async function deleteHotspot(id, el) {
      await sbFetch(`/rest/v1/hotspots?id=eq.${id}`, { method:'DELETE' });
      el.remove(); dzEls = dzEls.filter(x => x !== el);
    }

    // Attempts
    async function recordAttempt() {
      if (!studentEmail) return;
      const body = [{ activity_id: ACTIVITY_ID, student_email: studentEmail, placements, clicks: attempts, result: `${placements} placed / ${attempts} clicks` }];
      await sbFetch('/rest/v1/attempts', { method:'POST', headers:{ 'Content-Type':'application/json', 'Prefer':'return=representation' }, body: JSON.stringify(body) });
      refreshAttemptHistory();
    }

    async function refreshAttemptHistory() {
      if (!studentEmail) { attemptHistory.innerHTML = ''; return; }
      const rows = await sbFetch(`/rest/v1/attempts?activity_id=eq.${encodeURIComponent(ACTIVITY_ID)}&student_email=eq.${encodeURIComponent(studentEmail)}&select=*&order=completed_at.desc&limit=4`, { method:'GET' });
      attemptHistory.innerHTML = rows.map((r,i) => {
        const n = rows.length - i;
        return `<div><strong>Attempt ${n}</strong><br>${r.result}</div>`;
      }).join('<hr style="border:none;border-top:1px solid #eee;">');
    }

    // ====== DROPZONES ======
    function renderDropzoneFromRow(row) {
      const dz = document.createElement('div');
      dz.className = 'dropzone';
      dz.dataset.id = row.id;
      dz.dataset.correct = row.label;
      dz.dataset.xPct = row.x_pct ?? 0.5;
      dz.dataset.yPct = row.y_pct ?? 0.5;
      dz.dataset.sizePct = row.size_pct ?? DEFAULT_SIZE_PCT;
      dz.dataset.textScale = row.text_scale ?? 1;

      const span = document.createElement('span');
      span.className = 'label-text';
      span.textContent = row.label;
      dz.appendChild(span);

// ----- compact teacher controls -----
const controls = document.createElement('div');
controls.className = 'controls';
controls.innerHTML = `
  <div class="ctrl-delete">
    <button class="del" title="Delete">🗑</button>
  </div>
  <div class="ctrl-group">
    <div class="ctrl-title">Hotspot</div>
    <div class="ctrl-buttons">
      <button class="hsMinus" aria-label="Hotspot smaller">−</button>
      <button class="hsPlus"  aria-label="Hotspot larger">+</button>
    </div>
  </div>
  <div class="ctrl-group">
    <div class="ctrl-title">Text</div>
    <div class="ctrl-buttons">
      <button class="txMinus" aria-label="Text smaller">−</button>
      <button class="txPlus"  aria-label="Text larger">+</button>
    </div>
  </div>
`;
dz.appendChild(controls);

// ----- Student click (attempt) — keep this behavior the same -----
dz.addEventListener('click', async (e) => {
  if (isTeacher) return;              // teacher uses buttons / dragging
  if (!selectedLabel) return;

  attempts++;
  if (selectedLabel.textContent === dz.dataset.correct) {
    placements++;
    dz.classList.add('filled');       // hide circle, show text
    selectedLabel.remove();
    selectedLabel = null;

    if (placements === labels.length) {
      await recordAttempt();
      alert('Great job! Your score was saved.');
    }
  } else {
    dz.classList.add('flash');
    setTimeout(() => dz.classList.remove('flash'), 5000);
    selectedLabel.style.border = '2px solid #d4a017';
    setTimeout(() => { if (selectedLabel) selectedLabel.style.border = '2px solid #000'; }, 5000);
  }
  updateScore();
});

// ----- Teacher control listeners (new class names) -----
controls.querySelector('.del').addEventListener('click', async (e) => {
  e.stopPropagation(); if (!isTeacher) return;
  await deleteHotspot(dz.dataset.id, dz);
});

controls.querySelector('.hsPlus').addEventListener('click', async (e) => {
  e.stopPropagation(); if (!isTeacher) return;
  const newPct = Math.min(1, (parseFloat(dz.dataset.sizePct) || DEFAULT_SIZE_PCT) * 1.2);
  dz.dataset.sizePct = newPct; positionDropzone(dz);
  await updateHotspot(dz.dataset.id, { size_pct: newPct });
});

controls.querySelector('.hsMinus').addEventListener('click', async (e) => {
  e.stopPropagation(); if (!isTeacher) return;
  const newPct = Math.max(0.02, (parseFloat(dz.dataset.sizePct) || DEFAULT_SIZE_PCT) * 0.8);
  dz.dataset.sizePct = newPct; positionDropzone(dz);
  await updateHotspot(dz.dataset.id, { size_pct: newPct });
});

controls.querySelector('.txPlus').addEventListener('click', async (e) => {
  e.stopPropagation(); if (!isTeacher) return;
  const newScale = (parseFloat(dz.dataset.textScale) || 1) * 1.2;
  dz.dataset.textScale = newScale; positionDropzone(dz);
  await updateHotspot(dz.dataset.id, { text_scale: newScale });
});

controls.querySelector('.txMinus').addEventListener('click', async (e) => {
  e.stopPropagation(); if (!isTeacher) return;
  const newScale = Math.max(0.4, (parseFloat(dz.dataset.textScale) || 1) * 0.8);
  dz.dataset.textScale = newScale; positionDropzone(dz);
  await updateHotspot(dz.dataset.id, { text_scale: newScale });
});
      // Teacher: resize text (persist)
      controls.querySelector('.tBigger').addEventListener('click', async (e) => {
        e.stopPropagation(); if (!isTeacher) return;
        const newScale = (parseFloat(dz.dataset.textScale) || 1) * 1.2;
        dz.dataset.textScale = newScale; positionDropzone(dz);
        await updateHotspot(dz.dataset.id, { text_scale: newScale });
      });
      controls.querySelector('.tSmaller').addEventListener('click', async (e) => {
        e.stopPropagation(); if (!isTeacher) return;
        const newScale = Math.max(0.4, (parseFloat(dz.dataset.textScale) || 1) * 0.8);
        dz.dataset.textScale = newScale; positionDropzone(dz);
        await updateHotspot(dz.dataset.id, { text_scale: newScale });
      });

      // Teacher: drag hotspot
      let dragging = false, onMove, onUp;
      dz.addEventListener('mousedown', (e) => {
        if (!isTeacher) return;
        if (e.target.closest('.controls')) return; // don't start drag from buttons
        dragging = true; dz.classList.add('dragging');
        onMove = (ev) => {
          if (!dragging) return;
          const rect = bgImg.getBoundingClientRect();
          const xPct = (ev.clientX - rect.left) / rect.width;
          const yPct = (ev.clientY - rect.top)  / rect.height;
          dz.dataset.xPct = Math.min(1, Math.max(0, xPct));
          dz.dataset.yPct = Math.min(1, Math.max(0, yPct));
          positionDropzone(dz);
        };
        onUp = async () => {
          if (!dragging) return;
          dragging = false; dz.classList.remove('dragging');
          window.removeEventListener('mousemove', onMove);
          window.removeEventListener('mouseup', onUp);
          await updateHotspot(dz.dataset.id, {
            x_pct: parseFloat(dz.dataset.xPct),
            y_pct: parseFloat(dz.dataset.yPct)
          });
        };
        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onUp);
      });

      imgWrap.appendChild(dz);
      dzEls.push(dz);
      positionDropzone(dz);
      return dz;
    }

    function positionDropzone(dz) {
      const { w, h } = imgDims();
      const x = parseFloat(dz.dataset.xPct) * w;
      const y = parseFloat(dz.dataset.yPct) * h;
      const sz = (parseFloat(dz.dataset.sizePct) || DEFAULT_SIZE_PCT) * w;
      dz.style.left = `${x}px`;
      dz.style.top  = `${y}px`;
      dz.style.width  = `${sz}px`;
      dz.style.height = `${sz}px`;
      const scale = parseFloat(dz.dataset.textScale) || 1;
      const span = dz.querySelector('.label-text');
      if (span) span.style.fontSize = `${sz * 0.35 * scale}px`;  // baseline ~35% of circle width
    }

    function positionAllDropzones() { dzEls.forEach(positionDropzone); }

    // ====== IMAGE UPLOAD (Teacher) ======
    function publicImageURL(path) {
      // bucket is public; object public path:
      return `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${encodeURIComponent(path)}`;
    }

    changeImgBtn.addEventListener('click', () => imgFileInput.click());
    imgFileInput.addEventListener('change', async (e) => {
      if (!isTeacher) return;
      const file = e.target.files?.[0];
      if (!file) return;
      const key = `${ACTIVITY_ID}/${Date.now()}-${file.name}`;
      try {
        // Upload to storage
        await sbFetch(`/storage/v1/object/${BUCKET}/${encodeURIComponent(key)}`, {
          method:'POST',
          headers:{ 'Content-Type': file.type },
          body: file
        });
        const url = publicImageURL(key);
        // Update activities.image_url
        await sbFetch(`/rest/v1/activities?id=eq.${encodeURIComponent(ACTIVITY_ID)}`, {
          method:'PATCH', headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ image_url: url })
        });
        bgImg.src = url;
      } catch (err) {
        console.error(err);
        alert('Image upload failed. Check storage bucket/policies. See console for details.');
      } finally {
        imgFileInput.value = "";
      }
    });

    // ====== TEACHER CLICK TO CREATE HOTSPOT ======
    imgWrap.addEventListener('click', async (e) => {
      if (!isTeacher || !selectedLabel) return;
      if (e.target.closest('.dropzone')) return;  // ignore clicks on existing zones
      const rect = bgImg.getBoundingClientRect();
      const xPct = (e.clientX - rect.left) / rect.width;
      const yPct = (e.clientY - rect.top)  / rect.height;
      try {
        const dz = await createHotspot(selectedLabel.textContent, xPct, yPct, DEFAULT_SIZE_PCT);
        dz.classList.add('teacher'); // show controls immediately
      } catch (err) {
        console.error(err);
        alert('Could not save hotspot (check Supabase policies / keys).');
      }
    });

    // ====== UI WIRES ======
    function reflectModeUI() {
      modeBtn.textContent = isTeacher ? 'Switch to Student Mode' : 'Enter Teacher Mode';
      clearHotspotsBtn.style.display = isTeacher ? 'inline-block' : 'none';
      clearAnswersBtn.style.display  = isTeacher ? 'none' : 'inline-block';
      // teacher-only panels
      imagePanel.style.display = isTeacher ? 'block' : 'none';
      labelsPanel.style.display = isTeacher ? 'block' : 'none';
      // toggle teacher visuals
      document.querySelectorAll('.dropzone').forEach(dz => {
        if (isTeacher) dz.classList.add('teacher'); else dz.classList.remove('teacher');
      });
      // labels visibility in word bank
      renderWordBank();
      if (isTeacher) renderLabelManager();
    }

    modeBtn.addEventListener('click', () => {
      if (!isTeacher) {
        const pw = prompt('Enter teacher password:');
        if (pw !== TEACHER_PASSWORD) { alert('Incorrect password.'); return; }
        isTeacher = true;
      } else {
        isTeacher = false;
        attempts = 0; placements = 0; updateScore();
        selectedLabel = null;
      }
      reflectModeUI();
    });

    clearHotspotsBtn.addEventListener('click', async () => {
      if (!isTeacher) return;
      const zones = Array.from(document.querySelectorAll('.dropzone'));
      for (const dz of zones) { try { await deleteHotspot(dz.dataset.id, dz); } catch(e){ console.warn(e);} }
    });

    clearAnswersBtn.addEventListener('click', () => {
      attempts = 0; placements = 0; updateScore();
      document.querySelectorAll('.dropzone').forEach(dz => dz.classList.remove('filled'));
      renderWordBank();
    });

    // Labels panel buttons
    addLabelsBtn.addEventListener('click', async () => {
      const raw = labelsInput.value.trim();
      if (!raw) return;
      await addLabelsBulk(raw);
      labelsInput.value = "";
    });
    clearLabelsBtn.addEventListener('click', async () => {
      if (!confirm('Remove ALL labels for this activity?')) return;
      await clearLabels();
    });

    // ====== LOGIN ======
    function reflectLoginUI() {
      if (studentEmail) {
        emailInput.style.display = 'none';
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        loggedAs.textContent = `Logged in as ${studentEmail}`;
      } else {
        emailInput.style.display = 'inline-block';
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        loggedAs.textContent = '';
      }
      renderWordBank();
      refreshAttemptHistory().catch(()=>{});
    }

    loginBtn.addEventListener('click', () => {
      const v = (emailInput.value || '').trim();
      if (!v || !v.includes('@')) { alert('Please enter a valid email.'); return; }
      studentEmail = v;
      localStorage.setItem('studentEmail', studentEmail);
      reflectLoginUI();
    });

    logoutBtn.addEventListener('click', () => {
      studentEmail = '';
      localStorage.removeItem('studentEmail');
      reflectLoginUI();
      clearAnswersBtn.click();
      attemptHistory.innerHTML = '';
    });

    // ====== INIT ======
    async function init() {
      activityIdLabel.textContent = ACTIVITY_ID;
      updateScore();
      reflectLoginUI();          // renders word bank (student must login)
      reflectModeUI();           // ensure teacher panels hidden by default
      try {
        await ensureActivityRow();
        await loadActivityImage();
      } catch (e) {
        console.warn('Could not load activity row/image (will still try to render).', e);
      }
      const doLoad = async () => {
        try { await loadLabels(); await loadHotspots(); positionAllDropzones(); }
        catch (err) { console.error('Load failed', err); alert('Could not load data.'); }
      };
      if (bgImg.complete) doLoad();
      else bgImg.addEventListener('load', doLoad, { once:true });
      window.addEventListener('resize', positionAllDropzones);
    }
    init();
  </script>
</body>
</html>

